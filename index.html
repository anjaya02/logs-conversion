<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Log Converter</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        background-color: #f4f7f6;
        color: #333;
      }

      /* Loading Screen Styles */
      #loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #f4f7f6;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        transition: opacity 0.5s ease-out;
      }

      #loading-screen.hidden {
        opacity: 0;
        pointer-events: none;
      }

      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid rgba(0, 123, 255, 0.1);
        border-radius: 50%;
        border-top-color: #007bff;
        animation: spin 1s ease-in-out infinite;
        margin-bottom: 20px;
      }

      .loading-text {
        font-size: 18px;
        color: #555;
        margin-bottom: 10px;
      }

      .loading-subtext {
        font-size: 14px;
        color: #777;
        text-align: center;
        max-width: 300px;
        line-height: 1.4;
      }

      #app-container {
        background: white;
        padding: 40px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        text-align: center;
        width: 400px;
        opacity: 0;
        transition: opacity 0.5s ease-in;
      }

      #app-container.visible {
        opacity: 1;
      }
      h2 {
        margin-top: 0;
        color: #1a1a1a;
      }
      form {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      input[type="file"] {
        border: 2px dashed #ccc;
        border-radius: 6px;
        padding: 20px;
        background-color: #fafafa;
        cursor: pointer;
        transition: border-color 0.2s;
      }
      input[type="file"]::file-selector-button {
        margin-right: 15px;
        border: none;
        background: #007bff;
        padding: 10px 15px;
        border-radius: 5px;
        color: #fff;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      input[type="file"]::file-selector-button:hover {
        background: #0056b3;
      }
      input[type="file"]:hover {
        border-color: #007bff;
      }
      button {
        padding: 12px;
        border: none;
        background-color: #28a745;
        color: white;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      button:hover {
        background-color: #218838;
      }
      button:disabled {
        background-color: #aaa;
        cursor: not-allowed;
      }
      #status {
        margin-top: 20px;
        font-size: 14px;
      }
      .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border-left-color: #007bff;
        animation: spin 1s ease infinite;
        margin: 20px auto 0;
        display: none;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .error {
        color: #d93025;
      }
      .success {
        color: #218838;
      }
    </style>
  </head>
  <body>
    <!-- Loading Screen -->
    <div id="loading-screen">
      <div class="loading-spinner"></div>
      <div class="loading-text">Starting Log Converter...</div>
      <div class="loading-subtext">
        The server might be waking up from sleep. This usually takes 30-60
        seconds on first visit.
      </div>
    </div>

    <!-- Main App -->
    <div id="app-container">
      <h2>Upload ZIP â†’ Get CSV</h2>
      <form id="upload-form">
        <input type="file" name="file" accept=".zip" required />
        <button type="submit">Convert</button>
      </form>
      <div id="spinner" class="spinner"></div>
      <div id="status"></div>
    </div>

    <script>
      const form = document.getElementById("upload-form");
      const submitButton = form.querySelector("button");
      const statusDiv = document.getElementById("status");
      const spinner = document.getElementById("spinner");
      const fileInput = form.querySelector('input[type="file"]');
      const loadingScreen = document.getElementById("loading-screen");
      const appContainer = document.getElementById("app-container");

      // Function to check if server is ready
      // Replace your existing checkServerStatus function with this one
      async function checkServerStatus() {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout

        try {
          const response = await fetch(`/health?t=${new Date().getTime()}`, {
            method: "GET",
            signal: controller.signal,
          });
          clearTimeout(timeoutId); // Clear the timeout if the request succeeds
          return response.ok;
        } catch (error) {
          clearTimeout(timeoutId); // Clear the timeout if the request fails
          return false;
        }
      }

      // Initialize the app
      async function initializeApp() {
        let attempts = 0;
        const maxAttempts = 12; // 12 attempts = ~2 minutes

        while (attempts < maxAttempts) {
          const isReady = await checkServerStatus();

          if (isReady) {
            // Server is ready, hide loading screen and show app
            loadingScreen.classList.add("hidden");
            appContainer.classList.add("visible");
            return;
          }

          attempts++;

          // Update loading text based on attempts
          const loadingText = document.querySelector(".loading-text");
          const subText = document.querySelector(".loading-subtext");

          if (attempts <= 3) {
            loadingText.textContent = "Starting Log Converter...";
          } else if (attempts <= 6) {
            loadingText.textContent = "Waking up server...";
            subText.textContent =
              "The server is starting up. This may take up to 2 minutes on Render's free tier.";
          } else if (attempts <= 9) {
            loadingText.textContent = "Almost ready...";
            subText.textContent =
              "Still initializing. Thank you for your patience.";
          } else {
            loadingText.textContent = "Taking longer than expected...";
            subText.textContent =
              "The server should be ready soon. You can also try refreshing the page.";
          }

          // Wait 10 seconds before next attempt
          await new Promise((resolve) => setTimeout(resolve, 10000));
        }

        // If we get here, show an error state
        const loadingText = document.querySelector(".loading-text");
        const subText = document.querySelector(".loading-subtext");
        loadingText.textContent = "Connection Issue";
        loadingText.style.color = "#d93025";
        subText.innerHTML =
          "Unable to connect to the server. Please <a href='javascript:location.reload()' style='color: #007bff;'>refresh the page</a> to try again.";
      }

      // Start initialization when page loads
      window.addEventListener("DOMContentLoaded", initializeApp);

      form.addEventListener("submit", async (event) => {
        event.preventDefault();

        // --- UI Feedback Start ---
        submitButton.disabled = true;
        submitButton.textContent = "Processing...";
        spinner.style.display = "block";
        statusDiv.textContent = "Uploading and processing file...";
        statusDiv.className = "";

        const formData = new FormData();
        formData.append("file", fileInput.files[0]);

        // Show extended loading message after 5 seconds
        const extendedLoadingTimeout = setTimeout(() => {
          statusDiv.textContent =
            "Still processing... This may take longer if the server was sleeping.";
        }, 5000);

        try {
          const response = await fetch("/upload", {
            method: "POST",
            body: formData,
          });

          clearTimeout(extendedLoadingTimeout);

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || "An unknown error occurred.");
          }

          // --- Handle File Download ---
          const disposition = response.headers.get("content-disposition");
          let filename = "merged_sorted.csv"; // A fallback filename

          if (disposition && disposition.indexOf("attachment") !== -1) {
            const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
            const matches = filenameRegex.exec(disposition);
            if (matches != null && matches[1]) {
              filename = matches[1].replace(/['"]/g, "");
            }
          }

          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.style.display = "none";
          a.href = url;
          a.download = filename; // Use the dynamic filename from the server
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          a.remove();

          statusDiv.textContent = "Success! Your CSV has been downloaded.";
          statusDiv.className = "success";
        } catch (error) {
          statusDiv.textContent = `Error: ${error.message}`;
          statusDiv.className = "error";
        } finally {
          // --- Reset UI ---
          submitButton.disabled = false;
          submitButton.textContent = "Convert";
          spinner.style.display = "none";
          form.reset(); // Clear the selected file
        }
      });
    </script>
  </body>
</html>
